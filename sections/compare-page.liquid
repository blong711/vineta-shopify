{%- comment -%}Compare Page Section{%- endcomment -%}

<section class="flat-spacing-13">
    <div class="container">
        <div class="tf-compare-table" id="compareTable">
            <div id="compareContent">
                <!-- Content will be loaded via JavaScript -->
            </div>
        </div>
    </div>
</section>

<template id="compareTemplate">
    <div class="tf-compare-row tf-compare-grid">
        <div class="tf-compare-col d-md-block d-none"></div>
        {% for product in collections.all.products %}
            <div class="tf-compare-col" data-product-id="{{ product.id }}">
                <div class="tf-compare-item">
                    <a class="tf-compare-image" href="{{ product.url }}">
                        <img class="lazyload" 
                            data-src="{{ product.featured_image | img_url: '400x' }}"
                            src="{{ product.featured_image | img_url: '400x' }}" 
                            alt="{{ product.title | escape }}">
                    </a>
                    <div class="content">
                        <a class="tf-compare-title link text-md fw-medium" href="{{ product.url }}">{{ product.title }}</a>
                        <p class="price-wrap fw-medium text-md">
                            <span class="price-new text-primary">{{ product.price | money }}</span>
                            {% if product.compare_at_price > product.price %}
                                <span class="price-old text-dark">{{ product.compare_at_price | money }}</span>
                            {% endif %}
                        </p>
                        <div class="tf-compare-btn">
                            <button type="button" 
                                class="tf-btn animate-btn w-100" 
                                data-add-to-cart 
                                data-product-id="{{ product.id }}"
                                {% unless product.available %}disabled{% endunless %}>
                                {% if product.available %}
                                    Add to Cart
                                {% else %}
                                    Sold Out
                                {% endif %}
                            </button>
                        </div>
                    </div>
                    <div class="tf-compare-remove">
                        <span class="tf-btn-icon line d-inline-flex" data-compare 
                        data-id="{{ product.id }}" 
                        data-action="remove">
                            <i class="icon-close"></i>
                        </span>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="tf-compare-row">
        <div class="tf-compare-col tf-compare-field d-md-block d-none">
            <p class="text-md fw-medium">Availability</p>
        </div>
        {% for product in collections.all.products %}
            <div class="tf-compare-col tf-compare-field tf-compare-stock {% unless product.available %}text-red{% endunless %}" data-product-id="{{ product.id }}">
                <div class="icon">
                    {% if product.available %}
                        <i class="icon-fill-check-circle"></i>
                    {% else %}
                        <svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <g clip-path="url(#clip0_1_34903)">
                                <path d="M7.5 14.4955C11.366 14.4955 14.5 11.3635 14.5 7.50004C14.5 3.63659 11.366 0.504639 7.5 0.504639C3.63401 0.504639 0.5 3.63659 0.5 7.50004C0.5 11.3635 3.63401 14.4955 7.5 14.4955Z" fill="#E21B1B"/>
                                <path d="M5.28008 4.19648L4.19751 5.27905L9.72085 10.8024L10.8034 9.71982L5.28008 4.19648Z" fill="white"/>
                                <path d="M9.72036 4.19602L4.19702 9.71936L5.27959 10.8019L10.8029 5.27859L9.72036 4.19602Z" fill="white"/>
                            </g>
                            <defs>
                                <clipPath id="clip0_1_34903">
                                    <rect width="14" height="14" fill="white" transform="translate(0.5 0.5)"/>
                                </clipPath>
                            </defs>
                        </svg>
                    {% endif %}
                </div>
                <span>{% if product.available %}In Stock{% else %}Out of Stock{% endif %}</span>
            </div>
        {% endfor %}
    </div>

    <div class="tf-compare-row">
        <div class="tf-compare-col tf-compare-field d-md-block d-none">
            <p class="text-md fw-medium">Vendor</p>
        </div>
        {% for product in collections.all.products %}
            <div class="tf-compare-col tf-compare-value text-center" data-product-id="{{ product.id }}">
                <p class="text-sm">{{ product.vendor }}</p>
            </div>
        {% endfor %}
    </div>

    <div class="tf-compare-row">
        <div class="tf-compare-col tf-compare-field d-md-block d-none">
            <p class="text-md fw-medium">Color</p>
        </div>
        {% for product in collections.all.products %}
            <div class="tf-compare-col tf-compare-value text-center" data-product-id="{{ product.id }}">
                <p class="text-sm">
                    {%- assign color_option_index = nil -%}
                    {%- for option in product.options_with_values -%}
                        {%- if option.name == 'Color' or option.name == 'Colour' -%}
                            {%- assign color_option_index = forloop.index0 -%}
                        {%- endif -%}
                    {%- endfor -%}
                    {%- assign color_values = '' -%}
                    {%- if color_option_index != nil -%}
                        {%- for variant in product.variants -%}
                            {%- assign color = variant.options[color_option_index] -%}
                            {%- unless color_values contains color -%}
                                {%- assign color_values = color_values | append: color | append: ', ' -%}
                            {%- endunless -%}
                        {%- endfor -%}
                        {{ color_values | remove_last: ', ' | default: 'N/A' }}
                    {%- else -%}
                        N/A
                    {%- endif -%}
                </p>
            </div>
        {% endfor %}
    </div>
</template>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const compareIds = localStorage.getItem('theme4:compare:id') ? localStorage.getItem('theme4:compare:id').split(',') : [];
        const compareContent = document.getElementById('compareContent');
        const compareTemplate = document.getElementById('compareTemplate');
        
        if (compareIds.length === 0) {
            compareContent.innerHTML = '<div class="text-center"><p>No products to compare</p></div>';
            return;
        }

        // Clone the template content
        const content = compareTemplate.content.cloneNode(true);

        // Hide all product columns that are not in the compare list
        content.querySelectorAll('[data-product-id]').forEach(el => {
            if (!compareIds.includes(el.dataset.productId)) {
                el.style.display = 'none';
            }
        });

        // Add the content to the page
        compareContent.appendChild(content);

        // Listen for compare:updated event
        document.addEventListener('compare:updated', function(event) {
            const updatedCompareIds = localStorage.getItem('theme4:compare:id') ? localStorage.getItem('theme4:compare:id').split(',') : [];
            
            // Hide removed products
            document.querySelectorAll('[data-product-id]').forEach(el => {
                if (!updatedCompareIds.includes(el.dataset.productId)) {
                    el.style.display = 'none';
                }
            });

            // Show "No products" message if compare list is empty
            if (updatedCompareIds.length === 0) {
                compareContent.innerHTML = '<div class="text-center"><p>No products to compare</p></div>';
            }
        });
    });
</script>

{% schema %}    
{
  "name": "Compare Page",
  "settings": []
}
{% endschema %} 