<!DOCTYPE html>
<html lang="{{ request.locale.iso_code }}" dir="{{ settings.text_direction }}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="{{ settings.primary_button }}">
    <link rel="canonical" href="{{ canonical_url }}">
    
    <!-- Performance optimizations -->
    <link rel="dns-prefetch" href="//cdn.shopify.com">
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    {%- if settings.favicon != blank -%}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {%- endif -%}

    {%- if settings.apple_touch_icon != blank -%}
      <link rel="apple-touch-icon" href="{{ settings.apple_touch_icon | image_url: width: 180, height: 180 }}">
    {%- endif -%}

    <title>
      {{ page_title }}
      {%- if current_tags %} &ndash; tagged "{{ current_tags | join: ', ' }}"{% endif -%}
      {%- if current_page != 1 %} &ndash; Page {{ current_page }}{% endif -%}
      {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
    </title>

    {% if page_description %}
      <meta name="description" content="{{ page_description | escape }}">
    {% endif %}

    {% render 'meta-tags' %}

    <!-- SEO Meta Tags -->
    <meta name="robots" content="index, follow">
    <meta name="author" content="{{ shop.name }}">
    <meta name="keywords" content="{{ shop.name }}, {{ page_title | escape }}{% if current_tags %}, {{ current_tags | join: ', ' }}{% endif %}">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:site_name" content="{{ shop.name }}">
    <meta property="og:url" content="{{ canonical_url }}">
    <meta property="og:title" content="{{ page_title | escape }}">
    <meta property="og:type" content="{% if template contains 'product' %}product{% else %}website{% endif %}">
    {% if page_description %}
      <meta property="og:description" content="{{ page_description | escape }}">
    {% endif %}
    {% if template contains 'product' and product.featured_media %}
      <meta property="og:image" content="{{ product.featured_media | image_url: width: 1200, height: 1200 }}">
      <meta property="og:image:secure_url" content="{{ product.featured_media | image_url: width: 1200, height: 1200 }}">
    {% endif %}

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ page_title | escape }}">
    {% if page_description %}
      <meta name="twitter:description" content="{{ page_description | escape }}">
    {% endif %}
    {% if template contains 'product' and product.featured_media %}
      <meta name="twitter:image" content="{{ product.featured_media | image_url: width: 1200, height: 1200 }}">
    {% endif %}



    {{ content_for_header }}

    <!-- CSRF Protection -->
    <meta name="csrf-token" content="{{ csrf_token }}">

    <!-- Core CSS -->
    {{ 'fonts.css' | asset_url | stylesheet_tag }}
    {{ 'font-icons.css' | asset_url | stylesheet_tag }}
    {{ 'bootstrap.min.css' | asset_url | stylesheet_tag }}
    {{ 'bootstrap-select.min.css' | asset_url | stylesheet_tag }}
    {{ 'swiper-bundle.min.css' | asset_url | stylesheet_tag }}
    {{ 'photoswipe.css' | asset_url | stylesheet_tag }}
    {{ 'animate.css' | asset_url | stylesheet_tag }}
    {{ 'theme.css' | asset_url | stylesheet_tag }}
    {{ 'styles.css' | asset_url | stylesheet_tag }}
    {{ 'responsive-images.css' | asset_url | stylesheet_tag }}
    
    <!-- Conditional CSS loading -->
    {% if template contains 'product' %}
      {{ 'image-compare-viewer.min.css' | asset_url | stylesheet_tag }}
    {% endif %}

    <!-- Critical JavaScript - Load with high priority -->
    <script src="{{ 'jquery.min.js' | asset_url }}" defer></script>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="{{ 'bootstrap.min.js' | asset_url }}" as="script">
    <link rel="preload" href="{{ 'swiper-bundle.min.js' | asset_url }}" as="script">
    <link rel="preload" href="{{ 'theme.js' | asset_url }}" as="script">
    
    <!-- Core JavaScript - Load after critical -->
    <script src="{{ 'bootstrap.min.js' | asset_url }}" defer></script>
    <script src="{{ 'bootstrap-select.min.js' | asset_url }}" defer></script>
    <script src="{{ 'swiper-bundle.min.js' | asset_url }}" defer></script>
    
    <!-- jQuery-dependent scripts: load after jQuery, with defer -->
    <script src="{{ 'multiple-modal.js' | asset_url }}" defer></script>
    <script src="{{ 'carousel.js' | asset_url }}" defer></script>
    <script src="{{ 'infinityslide.js' | asset_url }}" defer></script>
    <script src="{{ 'paralaxei.js' | asset_url }}" defer></script>
    
    <!-- Non-critical JavaScript - Load with lower priority (async/lazy) -->
    <script src="{{ 'lazysize.min.js' | asset_url }}" async></script>
    <script src="{{ 'simpleParallaxVanilla.umd.js' | asset_url }}" async></script>
    <script src="{{ 'wow.min.js' | asset_url }}" async></script>
    <script src="{{ 'count-down.js' | asset_url }}" async></script>
    
    <!-- Conditional loading for specific features -->
    {% if template contains 'collection' or template contains 'search' %}
      <script src="{{ 'nouislider.min.js' | asset_url }}" async></script>
    {% endif %}
    
    {% if template contains 'product' %}
      <script type="module" src="{{ 'image-compare-viewer.js' | asset_url }}" async></script>
    {% endif %}
    
    <!-- Theme JavaScript - Load after core dependencies -->
    <script src="{{ 'theme.js' | asset_url }}" defer></script>
    <script src="{{ 'main.js' | asset_url }}" defer></script>
    <script src="{{ 'shop.js' | asset_url }}" defer></script>
    <script src="{{ 'global.js' | asset_url }}" defer></script>
    <script src="{{ 'product-card.js' | asset_url }}" defer></script>
    <script src="{{ 'application.js' | asset_url }}" defer></script>
    <script src="{{ 'responsive-images.js' | asset_url }}" defer></script>
    
    <!-- Model viewer - Load as module -->
    <script type="module" src="{{ 'model-viewer.min.js' | asset_url }}" async></script>

    {%- comment -%}Recently Viewed Tracking - Available globally{%- endcomment -%}
    {% render 'recently-viewed-tracking' %}
    
    <!-- Theme Settings CSS - External file for better CSP compliance -->
    {{ 'theme.css.liquid' | asset_url | stylesheet_tag }}
    
    <!-- Set animation data attribute -->
    <script>
      // Set animation data attribute with fallback
      const enableAnimations = {% if settings.enable_animations %}true{% else %}true{% endif %};
      document.documentElement.setAttribute('data-enable-animations', enableAnimations);
    </script>
</head>

  <body class="{% if template == 'page.phonecase' %}bg-surface-2{% endif %}">
    <!-- Scroll Top -->
    <button id="goTop">
      <span class="border-progress"></span>
      <span class="icon icon-arrow-right"></span>
    </button>

    <!-- Preload -->
    {% if settings.enable_preload %}
    <div class="preload preload-container">
      <div class="preload-logo">
        <div class="spinner"></div>
      </div>
    </div>
    {% endif %}

    <div id="wrapper">
      {% section 'top-bar' %}
      {% section 'header' %}
      
      <main role="main">
        {{ content_for_layout }}
      </main>
      {% section 'pickup-available' %}
      {% section 'footer' %}
      {% section 'cart-drawer' %}
      {% section 'search-drawer' %}
      {% render 'login-drawer' %}
      {% render 'register-drawer' %}
      {% render 'reset-password-drawer' %}
      {% section 'mobile-menu' %}
      {% section 'ask-question-drawer' %}
      {% section 'mobile-toolbar' %}
      {% section 'newsletter-popup' %}
      {% section 'cookie-banner' %}
      {% render 'quickview-modal' %}
      {% render 'compare-drawer' %}
    </div>
    {%- if request.design_mode -%}{%- render 'var_adm' -%}{% endif -%}
    <!-- Theme configuration and initialization -->
    <script>
      // Theme configuration - load immediately
      window.theme = {
        settings: {
          free_shipping_threshold: {{ settings.free_shipping_threshold | default: 10000 }},
          progress_message: {{ settings.progress_message | json | default: '"Spend <span class=\'fw-medium\'>[amount]</span> more to get <span class=\'fw-medium\'>Free Shipping</span>"' }},
          free_shipping_message: {{ settings.free_shipping_message | json | default: '"Congratulations! You\'ve unlocked <span class=\'fw-medium\'>Free Shipping</span>"' }}
        }
      };

      // Optimized Swiper initialization with debouncing
      let swiperInitTimeout;
      function debouncedInitializeSwipers() {
        clearTimeout(swiperInitTimeout);
        swiperInitTimeout = setTimeout(initializeAllSwipers, 50);
      }

      // Initialize swipers when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', debouncedInitializeSwipers);
      } else {
        debouncedInitializeSwipers();
      }

      // Theme editor event listeners with debouncing
      ['shopify:section:load', 'shopify:section:reorder', 'shopify:block:select'].forEach(eventType => {
        document.addEventListener(eventType, debouncedInitializeSwipers);
      });

      // Optimized initialization script with performance improvements
      document.addEventListener('DOMContentLoaded', function() {
        // Use requestIdleCallback for non-critical initialization
        const scheduleInit = (callback) => {
          if ('requestIdleCallback' in window) {
            requestIdleCallback(callback, { timeout: 2000 });
          } else {
            setTimeout(callback, 100);
          }
        };

        // Initialize jQuery plugins after jQuery is loaded
        var checkJQuery = setInterval(function() {
          if (window.jQuery) {
            clearInterval(checkJQuery);
            
            // Critical jQuery plugins - initialize immediately
            if ($.fn.selectpicker) {
              $('.selectpicker').selectpicker();
            }
            
            // Non-critical jQuery features - schedule for idle time
            scheduleInit(() => {
              if (typeof selectImages === 'function') {
                selectImages();
              }
              
              if (typeof filterProducts === 'function') {
                filterProducts();
              }
            });
          }
        }, 100);
      });

      // Optimized Swiper initialization function
      function initializeAllSwipers() {
        if (typeof Swiper === 'undefined') {
          // Retry after a short delay if Swiper isn't loaded yet
          setTimeout(initializeAllSwipers, 100);
          return;
        }

        const swiperElements = document.querySelectorAll('.tf-swiper, .tf-sw-slideshow');
        swiperElements.forEach(function(element) {
          // Skip if already initialized
          if (element.swiper && !element.swiper.destroyed) {
            return;
          }

          // Destroy existing swiper instance if it exists
          if (element.swiper) {
            element.swiper.destroy(true, true);
          }

          try {
            // If data-swiper attribute exists, use it
            if (element.dataset.swiper) {
              const options = JSON.parse(element.dataset.swiper);
              new Swiper(element, options);
            } else if (element.classList.contains('tf-sw-slideshow')) {
              // Build config for tf-sw-slideshow
              const getBool = v => v === 'true' || v === true;
              const getNum = v => v === undefined ? undefined : Number(v);
              
              const preview = getNum(element.dataset.preview) || 1;
              const tablet = getNum(element.dataset.tablet) || 1;
              const mobile = getNum(element.dataset.mobile) || 1;
              const spacing = getNum(element.dataset.space) || 0;
              const spacingMb = getNum(element.dataset.spaceMb) || 0;
              const loop = getBool(element.dataset.loop);
              const play = getBool(element.dataset.autoPlay);
              const centered = getBool(element.dataset.centered);
              const effect = element.dataset.effect || 'slide';
              const speed = getNum(element.dataset.speed) || 1000;
              
              const options = {
                autoplay: play ? {
                  delay: 5000,
                  disableOnInteraction: false,
                  pauseOnMouseEnter: true,
                } : false,
                slidesPerView: mobile,
                loop: loop,
                spaceBetween: spacingMb,
                speed: speed,
                observer: true,
                observeParents: true,
                pagination: {
                  el: '.sw-pagination-slider',
                  clickable: true,
                },
                navigation: {
                  clickable: true,
                  nextEl: '.swiper-button-next',
                  prevEl: '.swiper-button-prev',
                },
                centeredSlides: false,
                breakpoints: {
                  768: {
                    slidesPerView: tablet,
                    spaceBetween: spacing,
                    centeredSlides: false,
                  },
                  1200: {
                    slidesPerView: preview,
                    spaceBetween: spacing,
                    centeredSlides: centered,
                  },
                },
              };
              
              if (effect === 'fade') {
                options.effect = 'fade';
                options.fadeEffect = { crossFade: true };
              }
              
              new Swiper(element, options);
            }
          } catch (error) {
            console.warn('Failed to initialize swiper:', error);
          }
        });
      }
    </script>

    <!-- Structured Data -->
    {%- capture grich -%}
    {%- assign position = 1 %}
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [{
          "@type": "ListItem",
          "position": {{ position }},
          "name": "{{ 'general.breadcrumb.home' | t }}",
          "item": "{{ shop.url }}"
          {%- assign position = position | plus: 1 -%}
        }
        {%- if template.name == 'product' -%}
        {%- if product.collections.size > 0 -%},{
          "@type": "ListItem",
          "position": {{ position }},
          "name": {{ collection.title | default: product.collections.first.title | json }},
          "item": "{{ shop.url }}{{ collection.url | default: product.collections.first.url }}"
          {%- assign position = position | plus: 1 -%}
        }{%- endif -%},{
          "@type": "ListItem",
          "position": {{ position }},
          "name": {{ product.title | json }},
          "item": "{{ shop.url }}{{ product.url | within: collection }}"
          {%- assign position = position | plus: 1 -%}
        }
        {%- elsif template.name == 'list-collections' -%},{
          "@type": "ListItem",
          "position": {{ position }},
          "name": "Collections",
          "item": "{{ shop.url }}/collections"
          {%- assign position = position | plus: 1 -%}
        }
        {%- elsif template.name == 'collection' and collection.handle -%},{
          "@type": "ListItem",
          "position": {{ position }},
          "name": {{ collection.title | json }},
          "item": "{{ shop.url }}{{ collection.url }}"
          {%- assign position = position | plus: 1 -%}
        }
        {%- if current_tags -%}
        {%- for tag in current_tags -%},{
          "@type": "ListItem",
          "position": {{ position }},
          "name": {{ tag | json }},
          "item": "{{ shop.url }}{{ collection.url }}/{{ tag | handle }}"
          {%- assign position = position | plus: 1 -%}
        }
        {%- endfor -%}
        ,{
          "@type": "ListItem",
          "position": {{ position }},
          "name": "{{ page_title }}{%- if current_tags -%}{%- assign meta_tags = current_tags | join: ', ' %} &ndash; {{ 'general.meta.tag' | t: tags: meta_tags -}}{%- endif -%}",
          "item": "{{ canonical_url }}"
          {%- assign position = position | plus: 1 -%}
        }
        {%- endif -%}
        {%- elsif template.name == 'article' -%}
        ,{
          "@type": "ListItem",
          "position": {{ position }},
          "name": {{ blog.title | json }},
          "item": "{{ shop.url }}{{ blog.url }}"
          {%- assign position = position | plus: 1 -%}
        }
        ,{
          "@type": "ListItem",
          "position": {{ position }},
          "name": {{ article.title | json }},
          "item": "{{ shop.url }}{{ article.url }}"
          {%- assign position = position | plus: 1 -%}
        }
        {%- elsif template.name == 'blog' -%}
        ,{
          "@type": "ListItem",
          "position": {{ position }},
          "name": {{ blog.title | json }},
          "item": "{{ shop.url }}{{ blog.url }}"
          {%- assign position = position | plus: 1 -%}
        }
        {%- elsif template contains 'customers' -%}
        ,{
          "@type": "ListItem",
          "position": {{ position }},
          "name": "{{ 'customer.account.title' | t }}",
          "item": "{{ shop.url }}{{ page.url }}"
          {%- assign position = position | plus: 1 -%}
        }
        {%- else -%}
        {%- unless template.name == 'index' -%}
        ,{
          "@type": "ListItem",
          "position": {{ position }},
          "name": {{ page.title | json }},
          "item": "{{ shop.url }}{{ page.url }}"
          {%- assign position = position | plus: 1 -%}
        }
        {%- endunless -%}
        {%- endif -%}
        ]
      }
    </script>

    {%- if request.page_type == 'index' -%}
    {%- assign potential_action_target = shop.url | append: routes.search_url | append: "?q={search_term_string}" -%}
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "WebSite",
        "name": {{ shop.name | json }},
        "potentialAction": {
          "@type": "SearchAction",
          "target": {{ potential_action_target | json }},
          "query-input": "required name=search_term_string"
        },
        "url": {{ shop.url | append: page.url | json }}
      }
    </script>
    {%- elsif request.page_type == 'product' -%}
    <script type="application/ld+json">{{ product | structured_data }}</script>
    {%- elsif request.page_type == 'article' -%}
    <script type="application/ld+json">{{ article | structured_data }}</script>
    {%- endif -%}
    {%- endcapture -%}
    {{- grich | strip_newlines | remove: '  ' -}}
  </body>
</html> 