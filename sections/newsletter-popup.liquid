{% schema %}
{
  "name": "Newsletter Popup",
  "settings": [
    {
      "type": "image_picker",
      "id": "popup_image",
      "label": "Popup Image"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Sign up to our Newsletter"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Be the first to get the latest news about trends, promotions, and much more!"
    },
    {
      "type": "text",
      "id": "email_placeholder",
      "label": "Email Input Placeholder",
      "default": "Your email address"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Send"
    },
    {
      "type": "text",
      "id": "privacy_text",
      "label": "Privacy Text",
      "default": "Will be used in accordance with our Privacy Policy"
    },
    {
      "type": "url",
      "id": "privacy_link",
      "label": "Privacy Policy Link"
    }
  ],
  "presets": [
    {
      "name": "Newsletter Popup",
      "category": "Popup"
    }
  ]
}
{% endschema %}

<style>
  /* Theme customizer preview styles */
  .shopify-editor-section[data-section-id="{{ section.id }}"] {
    cursor: pointer;
    position: relative;
    min-height: 100px;
    border: 2px dashed #ddd;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f9f9f9;
    transition: all 0.3s ease;
  }
  
  .shopify-editor-section[data-section-id="{{ section.id }}"]:hover {
    border-color: #007cba;
    background: #f0f8ff;
  }
  
  .shopify-editor-section[data-section-id="{{ section.id }}"]::before {
    content: "ðŸ“§ Click to preview Newsletter Popup";
    font-size: 16px;
    color: #666;
    text-align: center;
    pointer-events: none;
  }
  
  .shopify-editor-section[data-section-id="{{ section.id }}"]:hover::before {
    color: #007cba;
    font-weight: 500;
  }
</style>

<div class="modal modalCentered fade auto-popup modal-newsletter">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-top">
        {% if section.settings.popup_image %}
          {{ section.settings.popup_image | image_url: width: 800 | image_tag: 
            loading: 'lazy',
            class: 'lazyload',
            alt: section.settings.popup_image.alt | default: 'Newsletter'
          }}
        {% endif %}
        <span class="icon icon-close btn-hide-popup" data-bs-dismiss="modal"></span>
      </div>
      <div class="modal-bottom text-center">
        <h5 class="title">{{ section.settings.title }}</h5>
        <p class="text text-sm text-main">{{ section.settings.subtitle }}</p>

        <form action="#" class="form-newsletter">
          <div class="mb_20">
            <fieldset class="email position-relative">
              <i class="icon icon-mail"></i>
              <input type="email" 
                     name="email" 
                     class="" 
                     placeholder="{{ section.settings.email_placeholder }}" 
                     tabindex="0"
                     aria-required="true" 
                     required>
            </fieldset>
          </div>
          <button class="subscribe-button tf-btn animate-btn d-inline-flex bg-dark-2 w-100" type="submit">
            {{ section.settings.button_text }}
          </button>
          <div class="mt-3">
            <label class="d-flex align-items-center justify-content-center">
              <input type="checkbox" id="dont-show-again" class="me-2">
              <span class="text-sm">Don't show this popup again</span>
            </label>
          </div>
        </form>

        <ul class="tf-social-icon style-default justify-content-center">
          {% if settings.social_twitter_link != blank %}
            <li>
              <a href="{{ settings.social_twitter_link }}" class="social-x">
                <i class="icon icon-x"></i>
              </a>
            </li>
          {% endif %}
          {% if settings.social_facebook_link != blank %}
            <li>
              <a href="{{ settings.social_facebook_link }}" class="social-facebook">
                <i class="icon icon-fb2"></i>
              </a>
            </li>
          {% endif %}
          {% if settings.social_instagram_link != blank %}
            <li>
              <a href="{{ settings.social_instagram_link }}" class="social-instagram">
                <i class="icon icon-instagram"></i>
              </a>
            </li>
          {% endif %}
          {% if settings.social_youtube_link != blank %}
            <li>
              <a href="{{ settings.social_youtube_link }}" class="social-youtube">
                <i class="icon icon-youtube"></i>
              </a>
            </li>
          {% endif %}
        </ul>
        <p class="text text-sm mb-0 text-main">
          {{ section.settings.privacy_text }}
          {% if section.settings.privacy_link %}
            <a href="{{ section.settings.privacy_link }}" class="fw-medium link">Privacy Policy</a>
          {% endif %}
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const popup = document.querySelector('.modal-newsletter');
    const dontShowAgainCheckbox = document.getElementById('dont-show-again');
    const closeButtons = document.querySelectorAll('.btn-hide-popup, [data-bs-dismiss="modal"]');
    
    // Check if popup should be hidden
    if (localStorage.getItem('newsletterPopupHidden') === 'true') {
      if (popup) {
        popup.remove();
      }
      return;
    }

    // Handle checkbox change
    dontShowAgainCheckbox.addEventListener('change', function() {
      if (this.checked) {
        localStorage.setItem('newsletterPopupHidden', 'true');
      } else {
        localStorage.removeItem('newsletterPopupHidden');
      }
    });

    // Handle close buttons
    closeButtons.forEach(button => {
      button.addEventListener('click', function() {
        if (dontShowAgainCheckbox.checked && popup) {
          popup.remove();
        }
      });
    });
  });

  // Theme customizer functionality
  if (typeof Shopify !== 'undefined' && Shopify.designMode) {
    document.addEventListener('DOMContentLoaded', function() {
      const sectionElement = document.querySelector('[data-section-id="{{ section.id }}"]');
      const popup = document.querySelector('.modal-newsletter');
      
      if (sectionElement && popup) {
        sectionElement.addEventListener('click', function(e) {
          // Prevent triggering when clicking on section settings
          if (e.target.closest('.shopify-editor-section__header') || 
              e.target.closest('.shopify-editor-section__settings')) {
            return;
          }
          
          // Show the popup modal
          const modal = new bootstrap.Modal(popup);
          modal.show();
        });
      }
    });
  }
</script>