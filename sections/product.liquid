{% comment %}
  Product Section
  - Multiple layout options: Default, Grid, Stacked
  - Responsive image gallery
  - Product information with variants
  - Add to cart functionality
{% endcomment %}

<section class="flat-single-product">
  <div class="tf-main-product section-image-zoom">
    <div class="container">
      <div class="row">
        <!-- Product Images -->
        <div class="col-md-6">
          {% if section.settings.layout == 'default' %}
            <div class="tf-product-media-wrap sticky-top">
              <div class="thumbs-slider">
                <div dir="ltr" class="swiper tf-product-media-thumbs other-image-zoom" data-preview="4" data-direction="vertical">
                  <div class="swiper-wrapper stagger-wrap">
                    {% for image in product.images %}
                      {% assign matched_variant = product.variants | where: 'featured_image', image | first %}
                      <div class="swiper-slide stagger-item" data-color="{% if matched_variant %}{{ matched_variant.option1 }}{% else %}{{ image.alt | default: 'default' }}{% endif %}">
                        <div class="item">
                          <img class="lazyload"
                            data-src="{{ image | image_url: width: 800 }}"
                            src="{{ image | image_url: width: 400 }}"
                            alt="{{ image.alt | default: product.title }}"
                            width="400"
                            height="600">
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
                <div class="flat-wrap-media-product">
                  <div dir="ltr" class="swiper tf-product-media-main tf-product-zoom-inner" id="gallery-swiper-started">
                    <div class="swiper-wrapper">
                      {% for image in product.images %}
                        {% assign matched_variant = product.variants | where: 'featured_image', image | first %}
                        <div class="swiper-slide" data-color="{% if matched_variant %}{{ matched_variant.option1 }}{% else %}{{ image.alt | default: 'default' }}{% endif %}">
                          <a href="{{ image | image_url: width: 1200 }}" target="_blank" class="item" data-pswp-width="552px" data-pswp-height="827px">
                            <img class="tf-image-zoom-inner lazyload"
                              data-zoom="{{ image | image_url: width: 1200 }}"
                              data-src="{{ image | image_url: width: 800 }}"
                              src="{{ image | image_url: width: 400 }}"
                              alt="{{ image.alt | default: product.title }}"
                              width="400"
                              height="600">
                          </a>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="swiper-button-next nav-swiper thumbs-next"></div>
                  <div class="swiper-button-prev nav-swiper thumbs-prev"></div>
                </div>
              </div>
            </div>
          {% else %}
            <div class="wrapper-gallery-scroll flat-single-grid{% if section.settings.layout == 'stacked' %} flat-single-stacked{% endif %}" id="gallery-started">
              {% for image in product.images %}
                <a href="{{ image | image_url: width: 1200 }}" data-scroll="{{ image.alt | default: 'default' }}" target="_blank" class="item item-scroll-target" data-pswp-width="552px" data-pswp-height="827px">
                  <img class="tf-image-zoom lazyload"
                    data-zoom="{{ image | image_url: width: 1200 }}"
                    data-src="{{ image | image_url: width: 800 }}"
                    src="{{ image | image_url: width: 400 }}"
                    alt="{{ image.alt | default: product.title }}">
                </a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
        <!-- /Product Images -->

        <!-- Product Info -->
        <div class="col-md-6">
          <div class="tf-product-info-wrap sticky-top position-relative">
            <div class="tf-zoom-main"></div>
            <div class="tf-product-info-list other-image-zoom">
              <div class="tf-product-info-heading">
                <h5 class="product-info-name fw-medium">{{ product.title }}</h5>
                <div class="product-info-rate">
                  <div class="list-star">
                    {% for i in (1..5) %}
                      <i class="icon icon-star"></i>
                    {% endfor %}
                  </div>
                  <span class="count-review">({{ product.metafields.reviews.rating_count | default: 'No review' }})</span>
                </div>
                <div class="product-info-price">
                  <div class="display-sm price-new price-on-sale">{{ product.price | money }}</div>
                  {% if product.compare_at_price > product.price %}
                    <div class="display-sm price-old">{{ product.compare_at_price | money }}</div>
                    <span class="badge-sale">{{ product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round }}% Off</span>
                  {% endif %}
                </div>
                {% if section.settings.show_sold_count %}
                  <div class="product-info-sold">
                    <svg class="icon" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M15.2759 10.9242C15.2556 10.6149 14.9236 10.4281 14.6488 10.5714C14.4098 10.6961 13.6603 11.0196 13.0698 11.0196C12.6156 11.0196 12.3132 10.8694 12.3132 10.1362C12.3132 8.12636 15.0124 6.52078 12.6056 3.51218C12.3295 3.16719 11.773 3.41746 11.8469 3.85238C11.8484 3.86145 11.9887 4.77182 11.5632 5.27582C11.3635 5.51218 11.061 5.62711 10.6384 5.62711C9.17454 5.62711 9.27646 1.94027 11.1223 0.795793C11.5328 0.541367 11.2702 -0.0948905 10.8012 0.0119845C10.683 0.0387033 7.88684 0.701328 6.39105 3.62798C5.28035 5.80099 5.88191 7.29977 6.32116 8.39418C6.71371 9.3722 6.89283 9.81857 6.01364 10.4273C5.68251 10.6566 5.42618 10.6328 5.42618 10.6328C4.60384 10.6328 3.82489 9.42402 3.59437 8.95879C3.40712 8.57837 2.83721 8.67311 2.78314 9.09372C2.75993 9.27457 2.24057 13.5513 4.51026 16.1312C5.76076 17.5525 7.50054 18.0581 9.40742 17.9948C11.1702 17.9357 12.5768 17.3395 13.5883 16.2228C15.4639 14.152 15.2844 11.0549 15.2759 10.9242Z" fill="#F2721C"/>
                      <path d="M4.44845 10.1357C4.04521 9.74669 3.72761 9.22817 3.59412 8.95877C3.40688 8.57834 2.83696 8.67309 2.78289 9.0937C2.75969 9.27454 2.24032 13.5513 4.51001 16.1312C5.2812 17.0077 6.27795 17.5784 7.48458 17.8379C4.95987 16.3506 4.24181 13.0162 4.44845 10.1357Z" fill="#EA5513"/>
                      <path d="M3.73448 4.51577C3.70506 4.49735 3.66772 4.49735 3.6383 4.51577C2.64745 5.13712 2.64446 6.58633 3.6383 7.20955C3.66723 7.22769 3.70471 7.22825 3.73448 7.20955C4.72533 6.58816 4.72821 5.13898 3.73448 4.51577Z" fill="#F2721C"/>
                      <path d="M4.12025 4.85809C4.01204 4.72502 3.88239 4.60855 3.73448 4.51577C3.70506 4.49735 3.66772 4.49735 3.6383 4.51577C2.64745 5.13712 2.64446 6.58633 3.6383 7.20955C3.66723 7.22769 3.70471 7.22825 3.73448 7.20955C3.88242 7.11677 4.01208 7.00026 4.12029 6.8672C3.64157 6.28237 3.64072 5.44386 4.12025 4.85809Z" fill="#EA5513"/>
                      <path d="M10.8011 0.0119845C10.6829 0.0387033 7.88676 0.701328 6.39096 3.62798C4.90723 6.53083 6.48163 8.24741 6.63386 9.34639L6.63403 9.34629C6.69 9.74974 6.54569 10.0588 6.01356 10.4272C5.69392 10.6486 5.40494 10.6816 5.10034 10.5723V10.5727C5.10034 10.5727 6.17507 11.6058 7.26087 10.8972C8.33686 10.1951 8.02601 9.11809 7.85986 8.63131L7.86025 8.63103C7.46365 7.57951 7.11673 6.19027 8.09319 4.27988C8.67292 3.14557 9.44797 2.35153 10.1868 1.80263C10.426 1.38835 10.7395 1.0331 11.1223 0.795758C11.5326 0.541367 11.2701 -0.0948905 10.8011 0.0119845Z" fill="#EA5513"/>
                    </svg>
                    <span class="text-dark">{{ section.settings.sold_count_text }}</span>
                  </div>
                {% endif %}
                {% if section.settings.show_stock_count %}
                  <div class="product-info-progress-sale">
                    <div class="title-hurry-up">
                      <span class="text-primary fw-medium">HURRY UP!</span> Only <span class="count">{{ product.variants.first.inventory_quantity }}</span> items left!
                    </div>
                    <div class="progress-sold">
                      <div class="value" style="width: {{ product.variants.first.inventory_quantity | times: 100 | divided_by: product.variants.first.inventory_policy | round }}%;" data-progress="70"></div>
                    </div>
                  </div>
                {% endif %}
              </div>

              <div class="tf-product-info-variant">
                {% for option in product.options_with_values %}
                  <div class="variant-picker-item variant-{{ option.name | handle }}">
                    <div class="variant-picker-label">
                      <div>{{ option.name }}:<span class="variant-picker-label-value value-current{{ option.name }}">{{ option.selected_value }}</span></div>
                      {% if option.name == 'Size' and section.settings.show_size_guide %}
                        <a href="#sizeGuide" data-bs-toggle="modal" class="size-guide link">Size Guide</a>
                      {% endif %}
                    </div>
                    <div class="variant-picker-values">
                      {% for value in option.values %}
                        {% if option.name == 'Color' %}
                          <div class="hover-tooltip tooltip-bot color-btn btn-scroll-target{% if value == option.selected_value %} active{% endif %}" 
                               data-scroll="{{ value | handle }}" 
                               data-option="{{ option.name | handle }}"
                               data-value="{{ value | handle }}">
                            <span class="check-color bg-{{ value | handle }}"></span>
                            <span class="tooltip">{{ value }}</span>
                          </div>
                        {% else %}
                          <span class="size-btn{% if value == option.selected_value %} active{% endif %}" 
                                data-size="{{ value | handle }}"
                                data-option="{{ option.name | handle }}"
                                data-value="{{ value | handle }}">{{ value }}</span>
                        {% endif %}
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
              </div>

              <div class="tf-product-total-quantity">
                <div class="group-btn">
                  <div class="wg-quantity">
                    <button class="btn-quantity btn-decrease">-</button>
                    <input class="quantity-product" type="text" name="number" value="1">
                    <button class="btn-quantity btn-increase">+</button>
                  </div>
                  <a href="javascript:void(0);" 
                     class="tf-btn hover-primary add-to-cart" 
                     data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                     data-quantity="1"
                     aria-label="Add to cart">Add to cart</a>
                </div>
                <a href="#" class="tf-btn btn-primary w-100 animate-btn">Buy it now</a>
                <a href="/checkout" class="more-choose-payment link">More payment options</a>
              </div>

              {% if section.settings.show_extra_links %}
                <div class="tf-product-info-extra-link">
                  <a href="javascript:void(0);" 
                  class="product-extra-icon link btn-wishlist" 
                  data-wishlist 
                     data-id="{{ product.id }}" 
                     data-action="add"
                     aria-label="Add to wishlist">
                     <span class="wishlist-content add">
                      <i class="icon icon-heart"></i>
                      <span class="text">Add to wishlist</span>
                    </span>
                    <span class="wishlist-content remove">
                      <i class="icon icon-trash"></i>
                      <span class="text">Remove from wishlist</span>
                    </span>
                  </a>
                  <a href="javascript:void(0);" 
                     class="product-extra-icon link" 
                     data-compare 
                     data-id="{{ product.id }}" 
                     data-action="add"
                     aria-label="Add to compare">
                    <i class="icon icon-compare2"></i>Compare
                  </a>
                  <a href="#askQuestion" data-bs-toggle="modal" class="product-extra-icon link"><i class="icon icon-ask"></i>Ask a question</a>
                  <a href="#shareSocial" data-bs-toggle="modal" class="product-extra-icon link"><i class="icon icon-share"></i>Share</a>
                </div>
              {% endif %}

              {% if section.settings.show_trust_seal %}
                <div class="tf-product-info-trust-seal text-center">
                  <p class="text-md text-dark-2 text-seal fw-medium">{{ section.settings.trust_seal_text }}</p>
                  <ul class="list-card">
                    {% for block in section.blocks %}
                      {% if block.type == 'payment_icon' and block.settings.image != blank %}
                        <li class="card-item" {{ block.shopify_attributes }}>
                          <img 
                            src="{{ block.settings.image | image_url: width: 60 }}" 
                            alt="{{ block.settings.image.alt | default: 'Payment method' }}" 
                            loading="lazy"
                            width="60"
                            height="40">
                        </li>
                      {% endif %}
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}

              {% if section.settings.show_delivery_info %}
                <div class="tf-product-info-delivery-return">
                  <div class="product-delivery">
                    <div class="icon icon-car2"></div>
                    <p class="text-md">Estimated delivery time: <span class="fw-medium">{{ section.settings.delivery_time }}</span></p>
                  </div>
                  <div class="product-delivery">
                    <div class="icon icon-shipping3"></div>
                    <p class="text-md">Free shipping on <span class="fw-medium">{{ section.settings.free_shipping_text }}</span></p>
                  </div>
                </div>
              {% endif %}
            </div>

            {% if section.settings.show_fbt %}
              <div class="tf-product-fbt">
                <div class="title text-xl fw-medium">Frequently Bought Together</div>
                <form class="tf-product-form-bundle">
                  <div class="tf-bundle-products">
                    {% assign collection = product.collections.first %}
                    {% if collection %}
                      {% assign related_products = collection.products | where: "available", true | where_not: "id", product.id | limit: 3 %}
                      {% for related_product in related_products %}
                        <div class="tf-bundle-product-item item-has-checkbox{% if forloop.first %} check{% endif %}">
                          <div class="bundle-check">
                            <input type="checkbox"{% if forloop.first %} checked="checked"{% endif %} class="tf-check" data-product-id="{{ related_product.id }}">
                          </div>
                          <a href="{{ related_product.url }}" class="bundle-image">
                            <img src="{{ related_product.featured_image | image_url: width: 200 }}" alt="{{ related_product.title }}">
                          </a>
                          <div class="bundle-info">
                            <div class="bundle-title text-sm fw-medium">{{ related_product.title }}</div>
                            <div class="bundle-price text-md fw-medium">
                              <span class="new-price">{{ related_product.price | money }}</span>
                              {% if related_product.compare_at_price > related_product.price %}
                                <span class="old-price">{{ related_product.compare_at_price | money }}</span>
                              {% endif %}
                            </div>
                            {% if related_product.has_only_default_variant == false %}
                              <div class="bundle-variant tf-select">
                                <select data-product-id="{{ related_product.id }}">
                                  {% for variant in related_product.variants %}
                                    <option value="{{ variant.id }}"{% if variant == related_product.selected_or_first_available_variant %} selected="selected"{% endif %}>
                                      {{ variant.title }} - {{ variant.price | money }}
                                    </option>
                                  {% endfor %}
                                </select>
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      {% endfor %}
                    {% endif %}
                  </div>
                  <div class="bundle-total-submit">
                    <div class="text">Total price:</div>
                    <span class="total-price">{{ product.price | money }}</span>
                    <span class="total-price-old" style="display: none;"></span>
                  </div>
                  <button type="button" class="btn-submit-total tf-btn btn-out-line-primary">Add selected to cart</button>
                </form>
              </div>

              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const form = document.querySelector('.tf-product-form-bundle');
                  const checkboxes = form.querySelectorAll('.tf-check');
                  const totalPrice = form.querySelector('.total-price');
                  const totalPriceOld = form.querySelector('.total-price-old');
                  const submitButton = form.querySelector('.btn-submit-total');
                  
                  let selectedProducts = new Set();
                  let total = {{ product.price }};
                  let totalCompare = {{ product.compare_at_price | default: product.price }};
                  
                  // Initialize with first product if checked
                  if (checkboxes[0]?.checked) {
                    selectedProducts.add(checkboxes[0].dataset.productId);
                  }
                  
                  function updateTotal() {
                    let newTotal = {{ product.price }};
                    let newTotalCompare = {{ product.compare_at_price | default: product.price }};
                    
                    checkboxes.forEach(checkbox => {
                      if (checkbox.checked) {
                        const productId = checkbox.dataset.productId;
                        const variantSelect = form.querySelector(`select[data-product-id="${productId}"]`);
                        if (variantSelect) {
                          const selectedOption = variantSelect.options[variantSelect.selectedIndex];
                          const price = parseInt(selectedOption.textContent.split(' - ')[1].replace(/[^0-9]/g, ''));
                          newTotal += price;
                        }
                      }
                    });
                    
                    totalPrice.textContent = formatMoney(newTotal);
                    if (newTotalCompare > newTotal) {
                      totalPriceOld.textContent = formatMoney(newTotalCompare);
                      totalPriceOld.style.display = 'inline';
                    } else {
                      totalPriceOld.style.display = 'none';
                    }
                  }
                  
                  checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                      const productId = this.dataset.productId;
                      if (this.checked) {
                        selectedProducts.add(productId);
                      } else {
                        selectedProducts.delete(productId);
                      }
                      updateTotal();
                    });
                  });
                  
                  form.querySelectorAll('select').forEach(select => {
                    select.addEventListener('change', updateTotal);
                  });
                  
                  submitButton.addEventListener('click', async function() {
                    const items = [];
                    
                    // Add main product
                    items.push({
                      id: {{ product.selected_or_first_available_variant.id }},
                      quantity: 1
                    });
                    
                    // Add selected bundle products
                    checkboxes.forEach(checkbox => {
                      if (checkbox.checked) {
                        const productId = checkbox.dataset.productId;
                        const variantSelect = form.querySelector(`select[data-product-id="${productId}"]`);
                        if (variantSelect) {
                          items.push({
                            id: variantSelect.value,
                            quantity: 1
                          });
                        }
                      }
                    });
                    
                    try {
                      const response = await fetch('/cart/add.js', {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ items })
                      });
                      
                      if (response.ok) {
                        // Open cart drawer
                        const cartDrawer = new bootstrap.Offcanvas(document.getElementById('shoppingCart'));
                        cartDrawer.show();
                        
                        // Refresh cart
                        if (window.cart) {
                          window.cart.refresh();
                        }
                      } else {
                        throw new Error('Failed to add items to cart');
                      }
                    } catch (error) {
                      console.error('Error adding items to cart:', error);
                      alert('Failed to add items to cart. Please try again.');
                    }
                  });
                });
              </script>
            {% endif %}
          </div>
        </div>
        <!-- /Product Info -->
      </div>
    </div>
  </div>

  {% if section.settings.show_sticky_cart %}
    <div class="tf-sticky-btn-atc">
      <div class="container">
        <div class="tf-height-observer w-100 d-flex align-items-center">
          <div class="tf-sticky-atc-product d-flex align-items-center">
            <div class="tf-sticky-atc-img">
              <img class="lazyload" data-src="{{ product.featured_image | image_url: width: 100 }}" src="{{ product.featured_image | image_url: width: 50 }}" alt="{{ product.title }}">
            </div>
            <div class="tf-sticky-atc-title fw-5 d-xl-block d-none">{{ product.title }}</div>
          </div>
          <div class="tf-sticky-atc-infos">
            <form class="">
              <div class="tf-sticky-atc-variant-price text-center tf-select">
                <select>
                  {% for variant in product.variants %}
                    <option value="{{ variant.id }}"{% if variant == product.selected_or_first_available_variant %} selected="selected"{% endif %}>
                      {{ variant.title }} - {{ variant.price | money }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="tf-sticky-atc-btns">
                <div class="tf-product-info-quantity">
                  <div class="wg-quantity">
                    <button class="btn-quantity minus-btn">-</button>
                    <input class="quantity-product font-4" type="text" name="number" value="1">
                    <button class="btn-quantity plus-btn">+</button>
                  </div>
                </div>
                <a href="javascript:void(0);" 
                class="tf-btn hover-primary add-to-cart" 
                data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                data-quantity="1"
                aria-label="Add to cart">Add to cart</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</section>

<style>
.btn-wishlist .wishlist-content {
  display: none;
}

.btn-wishlist .wishlist-content.add {
  display: inline-flex;
  align-items: center;
}

.btn-wishlist[data-action="remove"] .wishlist-content.add {
  display: none;
}

.btn-wishlist[data-action="remove"] .wishlist-content.remove {
  display: inline-flex;
  align-items: center;
}

.btn-wishlist .icon {
  margin-right: 5px;
}

/* Add zoom styles */
.tf-product-media-wrap {
  position: relative;
}

.tf-zoom-main {
  position: absolute;
  top: 0;
  left: 100%;
  width: 100%;
  height: 100%;
  background-size: 200%;
  background-repeat: no-repeat;
  display: none;
  z-index: 10;
  pointer-events: none;
  margin-left: 20px;
  border: 1px solid #eee;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.tf-image-zoom,
.tf-image-zoom-inner {
  cursor: zoom-in;
  transition: opacity 0.3s ease;
}

.tf-image-zoom:hover,
.tf-image-zoom-inner:hover {
  opacity: 0.9;
}

@media (max-width: 991px) {
  .tf-zoom-main {
    display: none !important;
  }
}

/* --- Image Zoom at Cursor --- */
.tf-image-zoom,
.tf-image-zoom-inner {
  transition: transform 0.4s cubic-bezier(.4,0,.2,1);
  will-change: transform;
  cursor: pointer;
}
.tf-image-zoom.zoomed,
.tf-image-zoom-inner.zoomed {
  transform: scale(2); /* Adjust zoom level as needed */
  z-index: 2;
  cursor: pointer;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM Content Loaded - Initializing product page');
  
  {% if section.settings.layout == 'default' %}
    console.log('Initializing default layout with Swiper');
    
    // Default layout with Swiper
    const galleryThumbs = new Swiper('.tf-product-media-thumbs', {
      direction: 'vertical',
      slidesPerView: 4,
      spaceBetween: 10,
      navigation: {
        nextEl: '.thumbs-next',
        prevEl: '.thumbs-prev',
      },
      breakpoints: {
        320: {
          direction: 'horizontal',
          slidesPerView: 4,
        },
        768: {
          direction: 'vertical',
          slidesPerView: 4,
        }
      }
    });

    const galleryMain = new Swiper('.tf-product-media-main', {
      slidesPerView: 1,
      spaceBetween: 10,
      thumbs: {
        swiper: galleryThumbs
      },
      navigation: {
        nextEl: '.thumbs-next',
        prevEl: '.thumbs-prev',
      },
      on: {
        slideChange: function() {
          console.log('Slide changed to index:', this.activeIndex);
          const activeSlide = this.slides[this.activeIndex];
          const color = activeSlide.getAttribute('data-color');
          console.log('Active slide color:', color);
          
          // Update color swatch
          document.querySelectorAll('.color-btn').forEach(btn => {
            if (
              btn.getAttribute('data-scroll') &&
              color &&
              btn.getAttribute('data-scroll').toLowerCase() === color.toLowerCase()
            ) {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          });

          // Find variant for this color
          const variant = findVariantByColor(color);
          console.log('Found variant for color:', variant);
          if (variant) {
            updateVariantSelection(variant);
          }
        }
      }
    });

    // Disable navigation buttons when at start/end
    function updateNavigationButtons() {
      console.log('Updating navigation buttons');
      console.log('Is beginning:', galleryMain.isBeginning);
      console.log('Is end:', galleryMain.isEnd);
      
      const prevButton = document.querySelector('.thumbs-prev');
      const nextButton = document.querySelector('.thumbs-next');
      
      if (galleryMain.isBeginning) {
        prevButton.classList.add('swiper-button-disabled');
      } else {
        prevButton.classList.remove('swiper-button-disabled');
      }
      
      if (galleryMain.isEnd) {
        nextButton.classList.add('swiper-button-disabled');
      } else {
        nextButton.classList.remove('swiper-button-disabled');
      }
    }

    galleryMain.on('slideChange', updateNavigationButtons);
    updateNavigationButtons();
  {% else %}
    // Grid and Stacked layout functionality
    const galleryItems = document.querySelectorAll('.item-scroll-target');
    const colorButtons = document.querySelectorAll('.btn-scroll-target');
    
    colorButtons.forEach(button => {
      button.addEventListener('click', function() {
        const color = this.getAttribute('data-scroll');
        document.querySelectorAll('.btn-scroll-target').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        galleryItems.forEach(item => {
          if (item.getAttribute('data-scroll') === color) {
            item.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        });
      });
    });
  {% endif %}

  // Store selected options
  let selectedOptions = {
    {% for option in product.options_with_values %}
      '{{ option.name | handle }}': '{{ option.selected_value | handle }}',
    {% endfor %}
  };
  console.log('Initial selected options:', selectedOptions);

  // Function to find variant by color
  function findVariantByColor(color) {
    console.log('Finding variant for color:', color);
    const variants = {{ product.variants | json }};
    const options = {{ product.options | json }};
    console.log('Available variants:', variants);
    console.log('Product options:', options);
    
    for (const variant of variants) {
      for (let i = 0; i < options.length; i++) {
        if (options[i].toLowerCase() === 'color' && 
            variant.options[i].toLowerCase() === color.toLowerCase()) {
          console.log('Found matching variant:', variant);
          return variant;
        }
      }
    }
    console.log('No variant found for color:', color);
    return null;
  }

  // Function to update variant selection
  function updateVariantSelection(variant) {
    console.log('Updating variant selection:', variant);
    if (!variant) {
      console.log('No variant provided, skipping update');
      return;
    }

    // Update add to cart button
    const addToCartBtn = document.querySelector('.add-to-cart');
    if (addToCartBtn) {
      console.log('Updating add to cart button variant ID:', variant.id);
      addToCartBtn.dataset.variantId = variant.id;
    } else {
      console.log('Add to cart button not found');
    }

    // Update price
    const priceElement = document.querySelector('.price-new');
    const oldPriceElement = document.querySelector('.price-old');
    if (priceElement) {
      console.log('Updating price to:', formatMoney(variant.price));
      priceElement.textContent = formatMoney(variant.price);
    }
    if (oldPriceElement) {
      if (variant.compare_at_price > variant.price) {
        console.log('Updating compare at price to:', formatMoney(variant.compare_at_price));
        oldPriceElement.textContent = formatMoney(variant.compare_at_price);
        oldPriceElement.style.display = 'inline';
      } else {
        oldPriceElement.style.display = 'none';
      }
    }

    // Update selected options
    variant.options.forEach((option, index) => {
      const optionName = {{ product.options | json }}[index].toLowerCase();
      selectedOptions[optionName] = option.toLowerCase();
    });
    console.log('Updated selected options:', selectedOptions);
  }

  // Handle color swatch clicks
  document.querySelectorAll('.color-btn').forEach(button => {
    button.addEventListener('click', function() {
      console.log('Color button clicked:', this);
      const color = this.getAttribute('data-scroll');
      console.log('Selected color:', color);
      
      // Update active state
      document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      
      // Find and update variant
      const variant = findVariantByColor(color);
      console.log('Found variant for clicked color:', variant);
      if (variant) {
        updateVariantSelection(variant);
      }

      // Update main image
      const mainSwiper = document.querySelector('.tf-product-media-main').swiper;
      const slides = mainSwiper.slides;
      console.log('Total slides:', slides.length);
      for (let i = 0; i < slides.length; i++) {
        if (slides[i].getAttribute('data-color') === color) {
          console.log('Found matching slide at index:', i);
          mainSwiper.slideTo(i);
          break;
        }
      }
    });
  });

  // Handle size variant selection
  document.querySelectorAll('.size-btn').forEach(button => {
    button.addEventListener('click', function() {
      const size = this.getAttribute('data-size');
      document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      
      // Update selected options
      selectedOptions['size'] = this.getAttribute('data-value');
      
      // Find and update variant ID
      const variantId = findVariantId();
      if (variantId) {
        const addToCartBtn = document.querySelector('.add-to-cart');
        if (addToCartBtn) {
          addToCartBtn.dataset.variantId = variantId;
        }
      }
    });
  });

  // Initialize image zoom
  const zoomMain = document.querySelector('.tf-zoom-main');
  const zoomImages = document.querySelectorAll('.tf-image-zoom');
  
  zoomImages.forEach(image => {
    image.addEventListener('mousemove', function(e) {
      const rect = this.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const xPercent = x / rect.width * 100;
      const yPercent = y / rect.height * 100;
      
      zoomMain.style.backgroundImage = `url(${this.getAttribute('data-zoom')})`;
      zoomMain.style.backgroundPosition = `${xPercent}% ${yPercent}%`;
      zoomMain.style.display = 'block';
    });
    
    image.addEventListener('mouseleave', function() {
      zoomMain.style.display = 'none';
    });
  });

  // Handle add to cart
  document.querySelectorAll('.add-to-cart').forEach(button => {
    button.addEventListener('click', async function(e) {
      e.preventDefault();
      
      // Prevent multiple clicks
      if (this.classList.contains('loading')) {
        return;
      }
      
      const variantId = this.dataset.variantId;
      const quantity = parseInt(this.dataset.quantity || 1);
      
      try {
        // Show loading state
        this.classList.add('loading');
        
        // Add item to cart
        if (window.cart) {
          await window.cart.updateQuantity(variantId, quantity, 'add');
          
          // Fetch updated cart data
          const response = await fetch('/cart.js');
          const cartData = await response.json();
          
          // Update cart drawer
          const cartDrawer = document.getElementById('shoppingCart');
          if (cartDrawer) {
            const itemsContainer = cartDrawer.querySelector('.tf-mini-cart-items');
            if (itemsContainer) {
              // Clear existing items
              itemsContainer.innerHTML = '';
              
              // Add all items from cart
              cartData.items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'tf-mini-cart-item';
                itemElement.style.border = 'none';
                itemElement.style.borderBottom = 'none';
                itemElement.innerHTML = `
                  <div class="tf-mini-cart-image">
                    <a href="${item.url}">
                      <img class="lazyload" data-src="${item.image}" src="${item.image}" alt="${item.title}" loading="lazy">
                    </a>
                  </div>
                  <div class="tf-mini-cart-info">
                    <div class="d-flex justify-content-between">
                      <a class="title link text-md fw-medium" href="${item.url}">${item.title}</a>
                      <i class="icon icon-close remove" data-variant-id="${item.variant_id}" aria-label="Remove item"></i>
                    </div>
                    <div class="d-flex gap-10">
                      <div class="text-xs">${item.variant_title || ''}</div>
                      <a href="#" class="link edit"><i class="icon-pen"></i></a>
                    </div>
                    <div class="tf-mini-cart-item_price">
                      <p class="price-wrap text-sm fw-medium">
                        <span class="new-price text-primary">${formatMoney(item.final_price)}</span>
                      </p>
                    </div>
                    <div class="tf-mini-cart-item_quantity">
                      <div class="wg-quantity small">
                        <button class="btn-quantity btn-decrease" data-variant-id="${item.variant_id}">-</button>
                        <input type="text" class="quantity-product" value="${item.quantity}" min="0" data-variant-id="${item.variant_id}">
                        <button class="btn-quantity btn-increase" data-variant-id="${item.variant_id}">+</button>
                      </div>
                    </div>
                  </div>
                `;
                itemsContainer.appendChild(itemElement);
              });
              
              // Add event listeners for quantity buttons
              itemsContainer.querySelectorAll('.btn-decrease').forEach(button => {
                button.addEventListener('click', async function() {
                  const variantId = this.dataset.variantId;
                  const input = this.nextElementSibling;
                  const currentValue = parseInt(input.value);
                  if (currentValue > 1) {
                    await window.cart.updateQuantity(variantId, currentValue - 1, 'update');
                  } else {
                    await window.cart.removeItem(variantId);
                  }
                });
              });
  
              itemsContainer.querySelectorAll('.btn-increase').forEach(button => {
                button.addEventListener('click', async function() {
                  const variantId = this.dataset.variantId;
                  const input = this.previousElementSibling;
                  const currentValue = parseInt(input.value);
                  await window.cart.updateQuantity(variantId, currentValue + 1, 'update');
                });
              });

              itemsContainer.querySelectorAll('.quantity-product').forEach(input => {
                input.addEventListener('change', async function() {
                  const variantId = this.dataset.variantId;
                  const newValue = parseInt(this.value);
                  if (isNaN(newValue) || newValue < 1) {
                    if (newValue <= 0) {
                      await window.cart.removeItem(variantId);
                    } else {
                      this.value = 1;
                      await window.cart.updateQuantity(variantId, 1, 'update');
                    }
                  } else {
                    await window.cart.updateQuantity(variantId, newValue, 'update');
                  }
                });
              });

              // Add event listeners for remove buttons
              itemsContainer.querySelectorAll('.remove').forEach(button => {
                button.addEventListener('click', async function() {
                  const variantId = this.dataset.variantId;
                  await window.cart.removeItem(variantId);
                });
              });
              
              // Update cart total
              const totalElement = cartDrawer.querySelector('.cart-total-price');
              if (totalElement) {
                totalElement.textContent = formatMoney(cartData.total_price);
              }
              
              // Update header cart count
              const headerCount = document.querySelector('.count-box');
              if (headerCount) {
                headerCount.textContent = cartData.item_count;
              }
            }
          }
        }
      } catch (error) {
        console.error('Error adding item to cart:', error);
        alert('Failed to add item to cart. Please try again.');
      } finally {
        // Remove loading state
        this.classList.remove('loading');
      }
    });
  });

  // Initialize wishlist and compare buttons state
  if (window.wishlistCompare) {
    window.wishlistCompare.updateButtonsState();
  }

  // Auto-select the color swatch for the initially selected variant
  const initialVariant = {{ product.selected_or_first_available_variant | json }};
  if (initialVariant && initialVariant.option1) {
    const initialColor = initialVariant.option1.toLowerCase();
    const colorBtn = Array.from(document.querySelectorAll('.color-btn')).find(
      btn => btn.getAttribute('data-scroll') && btn.getAttribute('data-scroll').toLowerCase() === initialColor
    );
    if (colorBtn) {
      colorBtn.click();
      console.log('Auto-selected color swatch for:', initialColor);
    } else {
      console.log('No color swatch found for initial color:', initialColor);
    }
  }

  // Remove .tf-zoom-main logic (no longer needed)
  // Add new zoom-at-cursor logic for all .tf-image-zoom and .tf-image-zoom-inner
  document.querySelectorAll('.tf-image-zoom, .tf-image-zoom-inner').forEach(image => {
    image.addEventListener('mousemove', function(e) {
      const rect = this.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;
      this.style.transformOrigin = `${x}% ${y}%`;
      this.classList.add('zoomed');
    });
    image.addEventListener('mouseleave', function() {
      this.classList.remove('zoomed');
      this.style.transformOrigin = 'center center';
    });
  });
});

// Helper function to format money
function formatMoney(cents) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: '{{ shop.currency }}'
  }).format(cents / 100);
}
</script>

{% schema %}
{
  "name": "Product",
  "settings": [
    {
      "type": "select",
      "id": "layout",
      "label": "Product Layout",
      "options": [
        {
          "value": "default",
          "label": "Default"
        },
        {
          "value": "grid",
          "label": "Grid"
        },
        {
          "value": "stacked",
          "label": "Stacked"
        }
      ],
      "default": "default"
    },
    {
      "type": "header",
      "content": "Trust Seal Settings"
    },
    {
      "type": "checkbox",
      "id": "show_trust_seal",
      "label": "Show Trust Seal",
      "default": true
    },
    {
      "type": "text",
      "id": "trust_seal_text",
      "label": "Trust Seal Text",
      "default": "Guarantee Safe Checkout:"
    },
    {
      "type": "checkbox",
      "id": "show_sold_count",
      "label": "Show Sold Count",
      "default": true
    },
    {
      "type": "text",
      "id": "sold_count_text",
      "label": "Sold Count Text",
      "default": "30 sold in last 24 hours"
    },
    {
      "type": "checkbox",
      "id": "show_stock_count",
      "label": "Show Stock Count",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_size_guide",
      "label": "Show Size Guide",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_extra_links",
      "label": "Show Extra Links",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_delivery_info",
      "label": "Show Delivery Info",
      "default": true
    },
    {
      "type": "text",
      "id": "delivery_time",
      "label": "Delivery Time",
      "default": "3-5 days international"
    },
    {
      "type": "text",
      "id": "free_shipping_text",
      "label": "Free Shipping Text",
      "default": "all orders over $150"
    },
    {
      "type": "checkbox",
      "id": "show_fbt",
      "label": "Show Frequently Bought Together",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_sticky_cart",
      "label": "Show Sticky Add to Cart",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "payment_icon",
      "name": "Payment Icon",
      "limit": 7,
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Payment Icon Image",
          "info": "Recommended size: 60x40px"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Payment Method Name",
          "default": "Payment Method"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product",
      "blocks": [
        {
          "type": "payment_icon"
        },
        {
          "type": "payment_icon"
        },
        {
          "type": "payment_icon"
        }
      ]
    }
  ]
}
{% endschema %}